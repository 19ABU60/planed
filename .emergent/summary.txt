<analysis>**original_problem_statement:**
The user, speaking German, requested a comprehensive teacher planning application named PlanEd. The initial goal was to replace an Excel-based system with a digital solution for managing work plans, subjects, classes, and holidays.

The project scope has significantly expanded to include:
- A Lernprogramme (Learning Resources) page.
- A Recherche (Research) page.
- An advanced Unterrichtsplanung (Lesson Planning) page that uses an AI model to generate detailed lesson plans and accompanying materials (worksheets, quizzes, etc.).
- Support for multiple subjects (Deutsch, Mathematik).
- The ability to generate, save, compare, and delete lesson plans.
- A feature to download all generated materials as editable Microsoft Word  files.
- An Excel import function for the main workplan.
- **New Requirements:**
    - Generate specific learning goals for each individual hour within a lesson plan.
    - Generate and download dedicated worksheet and solution sheet  files for each hour's specific tasks.
    - Deploy the application to a user-provided Hostinger VPS for permanent, 24/7 access.

**User's preferred language**: German. The next agent MUST respond in German.

**what currently exists?**
A full-stack application (React, FastAPI, MongoDB) with user authentication. Key functionalities include a workplan table, calendar, AI-powered lesson planning, and material generation with  export.

Key updates from the last session:
- **Major Frontend Refactoring:** The monolithic  (1920 lines) was successfully broken down into 8 smaller, reusable components located in , significantly improving maintainability.
- **New Feature Implemented:** The system can now generate hour-specific learning goals and create dedicated worksheets/solution sheets for each hour within a lesson plan. This involved updates to both backend (, ) and frontend ().
- **External Deployment:** The application has been deployed to the user's Hostinger VPS using Docker and Coolify. This required a major backend refactor, replacing the internal  library with the standard usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit library to allow external hosting. The application is running, but the core AI feature is not functional due to an API key configuration issue.

**Last working item**:
- **Last item agent was working:** Debugging a critical failure on the user's newly deployed Hostinger VPS. The core AI generation feature fails with an OpenAI nicht konfiguriert (OpenAI not configured) error because the running FastAPI application is not correctly loading the .
- **Status:** BLOCKED
- **Agent Testing Done:** N (The agent's debugging steps confirmed the key exists on the server, but the E2E test by the user fails.)
- **Which testing method agent to use?** Manual testing via python -c in the Coolify backend container terminal.
- **User Testing Done:** Y (and it repeatedly failed).

**All Pending/In progress Issue list**:
- **Issue 1: AI Generation Fails on Deployed Hostinger VPS (P0)**
    - **Description:** The core value proposition of the app—AI lesson generation—is completely broken on the user's live, self-hosted server. The  is not being accessed by the running  process, despite numerous attempts to provide it.
    - **Attempted fixes:**
        - Passing the key via Coolify's built-in Environment Variables (failed to be passed to the container).
        - Creating a persistent volume () and manually writing an  file () via the terminal.
        - Modifying  to explicitly load this  file on startup.
        - The agent confirmed the  file persists after restarts and that a standalone Python script in the terminal *can* read the key, but the running server process *cannot*.
    - **Next debug checklist:**
        1. Connect to the  container terminal in Coolify.
        2. Confirm the latest  with the  loading logic is present: .
        3. The core issue is that the server starts *before* the environment is correctly configured. A robust fix is needed. Re-implement a startup script () that explicitly sources the  file before executing the  server. The previous attempt at this was overwritten during the deployment chaos.
        4. The  should look like this:
           
        5. Update the  to use .
        6. Push to GitHub and redeploy. After redeploy, manually create the  file *one last time*. Check the logs for the INFO: Loaded... message.
    - **Why fix this issue and what will be achieved with the fix?** This is a complete blocker. Fixing it will make the user's self-hosted application fully functional as intended.
    - **Status:** BLOCKED
    - **Is recurring issue?** Y
    - **Should Test frontend/backend/both after fix?** backend
    - **Blocked on other issue:** None. This is the main blocker.

**In progress Task List**:
- **Task 1: Finalize Hostinger Deployment (P0)**
    - **Where to resume:** Implement the robust startup script fix detailed in Issue 1 to resolve the API key loading problem.
    - **What will be achieved with this?** A fully functional, self-hosted version of the PlanEd application on the user's VPS.
    - **Status:** IN PROGRESS
    - **Should Test frontend/backend/both after fix?** both
    - **Blocked on something:** Blocked by Issue 1.

**Upcoming and Future Tasks**
- **Upcoming Tasks:**
    - (P1) Text-to-Speech (TTS) Integration: Implement a Vorlesen (Read Aloud) feature for generated materials.
- **Future Tasks:**
    - (P2) PWA Auto-Update Notification: Implement a notification for PWA users when a new app version is available.
    - (P2) Connect a custom domain to the Hostinger VPS.
    - (P2) Add the ability to leave comments on shared work plans.
    - (P2) Enhance the statistics page.
    - (P2) Implement email alerts for shares and comments.

**Completed work in this session**
- **Frontend Refactoring:** Successfully refactored the massive  into 8 modular components, resolving the P0 bug from the previous session (multi-subject plan management) and improving code quality.
- **New Feature: Hour-Specific Materials:** Implemented the user's request for hour-specific learning goals and the generation of dedicated worksheets/solution sheets for each hour in a lesson plan.
- **Deployment & Backend Refactoring:** Deployed the application to the user's Hostinger VPS. This involved a significant backend refactor to remove the  library and use the standard usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit library, making external hosting possible.

**Earlier issues found/mentioned but not fixed**
- None.

**Known issue recurrence from previous fork**
- **Issue:** The user, who primarily uses Safari, consistently faces severe browser caching problems.
- **Recurrence count:** High.
- **Status:** NOT RESOLVED. This is a client-side issue. A PWA update notification is planned as a future task.

**Code Architecture**


**Key Technical Concepts**
- **Core:** React, FastAPI, MongoDB, .
- **Deployment:** Docker, Docker Compose, Nginx (in frontend container), Coolify (VPS management panel), Hostinger VPS.
- **AI:** usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit Python library (replaced ).
- **Technique:** Use of persistent volumes in Docker to maintain state ( file) across container restarts.

**key DB schema**
- ****: The  array within documents now contains a  (string) and  (array of strings) for each hour object.

**changes in tech stack**
- The AI backend has been migrated from the proprietary  library to the standard usage: openai [-h] [-v] [-b API_BASE] [-k API_KEY] [-p PROXY [PROXY ...]]
              [-o ORGANIZATION] [-t {openai,azure}]
              [--api-version API_VERSION] [--azure-endpoint AZURE_ENDPOINT]
              [--azure-ad-token AZURE_AD_TOKEN] [-V]
              {api,tools,migrate,grit} ...

positional arguments:
  {api,tools,migrate,grit}
    api                 Direct API calls
    tools               Client side tools for convenience

options:
  -h, --help            show this help message and exit
  -v, --verbose         Set verbosity.
  -b API_BASE, --api-base API_BASE
                        What API base url to use.
  -k API_KEY, --api-key API_KEY
                        What API key to use.
  -p PROXY [PROXY ...], --proxy PROXY [PROXY ...]
                        What proxy to use.
  -o ORGANIZATION, --organization ORGANIZATION
                        Which organization to run as (will use your default
                        organization if not specified)
  -t {openai,azure}, --api-type {openai,azure}
                        The backend API to call, must be `openai` or `azure`
  --api-version API_VERSION
                        The Azure API version, e.g.
                        'https://learn.microsoft.com/en-us/azure/ai-
                        services/openai/reference#rest-api-versioning'
  --azure-endpoint AZURE_ENDPOINT
                        The Azure endpoint, e.g.
                        'https://endpoint.openai.azure.com'
  --azure-ad-token AZURE_AD_TOKEN
                        A token from Azure Active Directory,
                        https://www.microsoft.com/en-
                        us/security/business/identity-access/microsoft-entra-
                        id
  -V, --version         show program's version number and exit library to facilitate external hosting.

**All files of reference**
- : Critical for deployment. Defines services, ports, and the persistent volume for the API key.
- : Defines how the backend image is built. Needs to be updated to use a  script.
- : Recently modified to attempt loading the  file on startup.
- : New service that centralizes all calls to the OpenAI API.
-  (on the deployed server): The manually created file in the persistent volume that holds the .

**Critical Info for New Agent**
- **PRIORITY #1:** Fix the OpenAI nicht konfiguriert error on the user's live server. This is a total blocker. Follow the Next debug checklist for Issue 1, focusing on implementing a robust  script.
- **DEPLOYMENT CONTEXT:** The app is deployed on the user's Hostinger VPS, managed via a web panel called Coolify. The agent has access to the container terminals through Coolify.
- **API KEY SECURITY:** The user's OpenAI API key has already been revoked once due to exposure. **DO NOT** write the key in the chat, logs, or commit it to GitHub. It must only exist in the  file, which is created manually on the server.
- **Communicate in German.**

**documents and test reports created in this job**
- 
- 
- 
- 
- 

**Last 10 User Messages and any pending HUMAN messages**
The user is very frustrated with the deployment issues. The last sequence of messages involved the agent and user trying various debugging steps in the Coolify terminal to solve the nicht konfiguriert error. The user confirmed that the  file with the key was persistent after a restart, but the Python environment check showed the key was still not being loaded into the running server process, leading to the final nicht konfiguriert error message before the session ended.

**Project Health Check:**
- **Broken:** The core AI generation functionality on the self-hosted production server is non-operational.
- **Mocked:** None.

**3rd Party Integrations**
- **OpenAI:** Replaced Gemini for all AI generation tasks. Requires a user-provided API Key.
- **Hostinger/Coolify:** The platform for the self-hosted deployment.
- **:** For generating  files.
- , , OpenAlex, Wikimedia Commons.

**Testing status**
- **Testing agent used after significant changes:** YES (for the initial frontend refactoring).
- **Test files created:** None in this session.
- **Known regressions:** The entire AI functionality is broken on the deployed server.

**Credentials to test flow:**
- **App Login:**
    - User: 
    - Password: 
- **Server Access (via Coolify Terminal):**
    - Coolify URL:  (user has login)
- **OpenAI API Key:** The user has the current, valid key. Do not ask for it. Instruct the user to re-enter it when needed.

**What agent forgot to execute**
- The agent did not implement a sufficiently robust mechanism for loading the API key during the deployment process. Attempts to modify  or create a  script were made but were lost or ineffective during the chaotic debugging. A final, solid implementation of a startup script that  the key before -ing the server is required.</analysis>
